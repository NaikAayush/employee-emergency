{"version":3,"sources":["./src/app/command-center/views/tabs/command-center-map/command-center-map.page.ts","./src/app/command-center/views/tabs/command-center-map/command-center-map.module.ts","./src/app/command-center/views/tabs/command-center-map/command-center-map-routing.module.ts","./src/app/command-center/views/tabs/command-center-map/command-center-map.page.html","./src/app/command-center/views/tabs/command-center-map/command-center-map.page.scss"],"names":[],"mappings":"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","file":"tabs-command-center-map-command-center-map-module.js","sourcesContent":["import { Component, OnInit } from '@angular/core';\r\nimport { fabric } from 'fabric';\r\nimport { PathfindingService } from 'src/app/employee/services/pathfinding/pathfinding.service';\r\nimport { ChoiceInfo } from 'src/app/employee/views/tabs/employee-map/models/choice-info';\r\nimport { environment } from 'src/environments/environment';\r\n\r\n@Component({\r\n  selector: 'app-command-center-map',\r\n  templateUrl: './command-center-map.page.html',\r\n  styleUrls: ['./command-center-map.page.scss'],\r\n})\r\nexport class CommandCenterMapPage implements OnInit {\r\n  private canvas: fabric.Canvas;\r\n  uuidMap: string = 'a246ddf4-3ded-49b9-bacf-fbf7b700e49e';\r\n  // user ids to monitor\r\n  userIds: string[] = [\"592s1XmfNwYujg7Y1thbkDyOTZf2\", \"brr\", \"LxhvXHuCJxUXITPfzmYAnKJb6uf2\", \"abc\"];\r\n\r\n  // icons\r\n  private exitIcon!: HTMLImageElement;\r\n  private entryIcon!: HTMLImageElement;\r\n  private beaconIcon!: HTMLImageElement;\r\n\r\n  // choices, so many choices\r\n  private choicesInfo: Record<string, ChoiceInfo> = {\r\n    exit: {\r\n      iconEl: this.exitIcon,\r\n      iconSrc: 'assets/img/exit.svg',\r\n    },\r\n    entry: {\r\n      iconEl: this.entryIcon,\r\n      iconSrc: 'assets/img/entry.svg',\r\n    },\r\n    beacon: {\r\n      iconEl: this.beaconIcon,\r\n      iconSrc: 'assets/img/beacon.svg',\r\n    },\r\n  };\r\n  private choices = ['exit', 'entry', 'beacon'];\r\n\r\n  // user markers\r\n  private userMarkers: Record<string, fabric.Group>;\r\n\r\n  constructor(private pathfinding: PathfindingService) {\r\n    this.userMarkers = {};\r\n  }\r\n\r\n  async ngOnInit() {\r\n    // initialize canvas\r\n    this.canvas = new fabric.Canvas('mapFabricCanvas');\r\n    this.canvas.selection = false;\r\n\r\n    this.canvas.height = 0;\r\n    this.canvas.width = 0;\r\n\r\n    // setup icons\r\n    this.choices.forEach((choice: string) => {\r\n      let choiceInfo = this.choicesInfo[choice];\r\n      choiceInfo.iconEl = new Image();\r\n      choiceInfo.iconEl.src = choiceInfo.iconSrc;\r\n    });\r\n\r\n    let orig_img = await this.pathfinding.initialize(this.uuidMap);\r\n\r\n    this.canvas.setWidth(orig_img.width);\r\n    // this.canvas.height = orig_img.height;\r\n    this.canvas.setHeight(orig_img.height);\r\n    // this.canvas.width = orig_img.width;\r\n    this.canvas.setDimensions(\r\n      {\r\n        width: '100%',\r\n        height: '',\r\n      },\r\n      {\r\n        cssOnly: true,\r\n      }\r\n    );\r\n\r\n    const height = this.canvas.getHeight();\r\n    console.log('height is ', height);\r\n    this.canvas.hoverCursor = 'auto';\r\n\r\n    let orig_img_f = new fabric.Image(orig_img, {\r\n      left: 0,\r\n      top: 0,\r\n      lockMovementX: true,\r\n      lockMovementY: true,\r\n      lockScalingX: true,\r\n      selectable: false,\r\n    });\r\n    this.canvas.add(orig_img_f);\r\n\r\n    this.addMarkers();\r\n\r\n    this.startMonitoring();\r\n  }\r\n\r\n  private addMarkers() {\r\n    this.pathfinding.mapDoc\r\n      .get()\r\n      .toPromise()\r\n      .then(async (res) => {\r\n        const mapData = res.data();\r\n        console.log(mapData);\r\n\r\n        for (let marker of mapData.markers) {\r\n          let iconImg = new fabric.Image(this.choicesInfo[marker.name].iconEl, {\r\n            left: marker.left,\r\n            top: marker.top,\r\n            selectable: false,\r\n            width: marker.width,\r\n            height: marker.height,\r\n          });\r\n          iconImg.data = { name: marker.name };\r\n          this.canvas.add(iconImg);\r\n        }\r\n      });\r\n  }\r\n\r\n  private startMonitoring() {\r\n    this.userIds.forEach((uid) => {\r\n      const listenWs = new WebSocket(`${environment.wsEndpoint}listen?id=${uid}`);\r\n\r\n      listenWs.addEventListener('open', function() {\r\n        listenWs.send('Hello Server!');\r\n      });\r\n\r\n      listenWs.addEventListener('message', (event) => {\r\n        try {\r\n          let data = JSON.parse(event.data);\r\n          console.log('Message from server ', data);\r\n\r\n          if (this.userMarkers[uid]) {\r\n            console.log(\"found\");\r\n            // this.userMarkers[uid].set({\r\n            //   // left: data.x,\r\n            //   top: data.y,\r\n            // });\r\n\r\n            fabric.util.animate({ startValue: this.userMarkers[uid].left, endValue: data.x, onChange: (val) => { this.userMarkers[uid].left = val; this.userMarkers[uid].setCoords(); this.canvas.renderAll(); } });\r\n\r\n            fabric.util.animate({ startValue: this.userMarkers[uid].top, endValue: data.y, onChange: (val) => { this.userMarkers[uid].top = val; this.userMarkers[uid].setCoords(); this.canvas.renderAll(); } });\r\n\r\n            // this.userMarkers[uid].setCoords();\r\n            // this.canvas.renderAll();\r\n          } else {\r\n            let color = \"red\";\r\n\r\n            if (data.ert) {\r\n              color = \"blue\";\r\n            }\r\n\r\n            let reect = new fabric.Rect({\r\n              height: 10,\r\n              width: 10,\r\n              fill: color,\r\n              originX: \"center\",\r\n              originY: \"center\"\r\n            });\r\n            let text = new fabric.Text(data.name, {\r\n              fontSize: 10,\r\n              top: 10,\r\n              originX: \"center\",\r\n              originY: \"center\"\r\n            });\r\n\r\n            this.userMarkers[uid] = new fabric.Group([reect, text], {\r\n              left: data.x,\r\n              top: data.y,\r\n              selectable: false\r\n            });\r\n\r\n            this.canvas.add(this.userMarkers[uid]);\r\n          }\r\n        } catch (error) {\r\n          console.log('Bad data from WS', error);\r\n        }\r\n      });\r\n    });\r\n  }\r\n\r\n}\r\n","import { NgModule } from '@angular/core';\r\nimport { CommonModule } from '@angular/common';\r\nimport { FormsModule } from '@angular/forms';\r\n\r\nimport { IonicModule } from '@ionic/angular';\r\n\r\nimport { CommandCenterMapPageRoutingModule } from './command-center-map-routing.module';\r\n\r\nimport { CommandCenterMapPage } from './command-center-map.page';\r\n\r\n@NgModule({\r\n  imports: [\r\n    CommonModule,\r\n    FormsModule,\r\n    IonicModule,\r\n    CommandCenterMapPageRoutingModule\r\n  ],\r\n  declarations: [CommandCenterMapPage]\r\n})\r\nexport class CommandCenterMapPageModule {}\r\n","import { NgModule } from '@angular/core';\r\nimport { Routes, RouterModule } from '@angular/router';\r\n\r\nimport { CommandCenterMapPage } from './command-center-map.page';\r\n\r\nconst routes: Routes = [\r\n  {\r\n    path: '',\r\n    component: CommandCenterMapPage\r\n  }\r\n];\r\n\r\n@NgModule({\r\n  imports: [RouterModule.forChild(routes)],\r\n  exports: [RouterModule],\r\n})\r\nexport class CommandCenterMapPageRoutingModule {}\r\n","export default \"<ion-header>\\r\\n  <ion-toolbar>\\r\\n    <ion-title>command-center-map</ion-title>\\r\\n  </ion-toolbar>\\r\\n</ion-header>\\r\\n\\r\\n<ion-content>\\r\\n\\r\\n<canvas id=\\\"mapFabricCanvas\\\"></canvas>\\r\\n\\r\\n</ion-content>\\r\\n\";","export default \"\\n/*# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IiIsImZpbGUiOiJjb21tYW5kLWNlbnRlci1tYXAucGFnZS5zY3NzIn0= */\";"],"sourceRoot":"webpack:///"}